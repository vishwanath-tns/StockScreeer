#!/usr/bin/env python3
"""
Simplified Historical Planetary Browser
Stable version with better error handling and no hanging issues

This version focuses on:
1. Simple data browser without complex collection
2. Proper close handling
3. Error recovery
4. No background processes that can hang
"""

import sys
import os
import sqlite3
from datetime import datetime, timedelta
from typing import Dict, Any, Optional
import traceback

# Add tools to path
sys.path.append(os.path.join(os.path.dirname(__file__), 'tools'))

try:
    import tkinter as tk
    from tkinter import ttk, messagebox
    from tkcalendar import DateEntry
except ImportError as e:
    print(f"Import error: {e}")
    print("Please install: pip install tkcalendar")
    sys.exit(1)

class SimplePlanetaryBrowser:
    """
    Simple, stable planetary data browser
    """
    
    def __init__(self):
        self.root = None
        self.db_path = "historical_planetary_data.db"
        self.setup_gui()
    
    def setup_gui(self):
        """Setup simple GUI"""
        try:
            self.root = tk.Tk()
            self.root.title("Simple Planetary Data Browser")
            self.root.geometry("1000x700")
            
            # Proper close handling
            self.root.protocol("WM_DELETE_WINDOW", self.on_close)
            
            # Configure style
            style = ttk.Style()
            style.theme_use('clam')
            
            self.setup_main_interface()
            
        except Exception as e:
            print(f"GUI setup error: {e}")
            self.safe_exit()
    
    def setup_main_interface(self):
        """Setup main interface"""
        # Main frame
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.pack(fill=tk.BOTH, expand=True)
        
        # Header
        header_frame = ttk.Frame(main_frame)
        header_frame.pack(fill=tk.X, pady=(0, 10))\n        \n        title_label = ttk.Label(header_frame, text="ğŸŒŸ Simple Planetary Data Browser", \n                               font=("Arial", 16, "bold"))\n        title_label.pack(side=tk.LEFT)\n        \n        # Close button in header\n        ttk.Button(header_frame, text="âŒ Close", \n                  command=self.on_close).pack(side=tk.RIGHT)\n        \n        # Status\n        self.status_label = ttk.Label(header_frame, text="Ready", foreground="blue")\n        self.status_label.pack(side=tk.RIGHT, padx=(0, 10))\n        \n        # Controls\n        control_frame = ttk.LabelFrame(main_frame, text="Date & Time Selection", padding="10")\n        control_frame.pack(fill=tk.X, pady=(0, 10))\n        \n        # Date picker\n        ttk.Label(control_frame, text="Date:").grid(row=0, column=0, padx=5)\n        \n        try:\n            self.date_entry = DateEntry(control_frame, width=12, \n                                      mindate=datetime(2024, 1, 1),\n                                      maxdate=datetime(2025, 12, 31),\n                                      date_pattern='yyyy-mm-dd')\n            self.date_entry.set_date(datetime(2024, 1, 1))\n            self.date_entry.grid(row=0, column=1, padx=5)\n        except:\n            # Fallback if DateEntry fails\n            self.date_var = tk.StringVar(value=\"2024-01-01\")\n            ttk.Entry(control_frame, textvariable=self.date_var, width=12).grid(row=0, column=1, padx=5)\n        \n        # Time controls\n        ttk.Label(control_frame, text="Hour:").grid(row=0, column=2, padx=5)\n        self.hour_var = tk.StringVar(value=\"00\")\n        hour_spin = ttk.Spinbox(control_frame, from_=0, to=23, width=3, \n                               textvariable=self.hour_var, format=\"%02.0f\")\n        hour_spin.grid(row=0, column=3, padx=5)\n        \n        ttk.Label(control_frame, text=\"Minute:\").grid(row=0, column=4, padx=5)\n        self.minute_var = tk.StringVar(value=\"00\")\n        minute_spin = ttk.Spinbox(control_frame, from_=0, to=59, width=3, \n                                 textvariable=self.minute_var, format=\"%02.0f\")\n        minute_spin.grid(row=0, column=5, padx=5)\n        \n        # Buttons\n        ttk.Button(control_frame, text=\"ğŸ” Query Data\", \n                  command=self.safe_query_data).grid(row=0, column=6, padx=10)\n        ttk.Button(control_frame, text=\"ğŸ§® Test Calculator\", \n                  command=self.test_calculator).grid(row=0, column=7, padx=5)\n        \n        # Results display\n        results_frame = ttk.LabelFrame(main_frame, text=\"Planetary Positions\", padding=\"10\")\n        results_frame.pack(fill=tk.BOTH, expand=True)\n        \n        # Create text widget for results\n        self.results_text = tk.Text(results_frame, wrap=tk.WORD, width=80, height=25)\n        results_scroll = ttk.Scrollbar(results_frame, orient=tk.VERTICAL, \n                                     command=self.results_text.yview)\n        self.results_text.configure(yscrollcommand=results_scroll.set)\n        \n        self.results_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)\n        results_scroll.pack(side=tk.RIGHT, fill=tk.Y)\n        \n        # Initial status check\n        self.check_database_status()\n    \n    def on_close(self):\n        \"\"\"Handle close event safely\"\"\"\n        try:\n            print(\"Closing application...\")\n            if self.root:\n                self.root.quit()\n                self.root.destroy()\n        except Exception as e:\n            print(f\"Close error: {e}\")\n        finally:\n            self.safe_exit()\n    \n    def safe_exit(self):\n        \"\"\"Safe exit method\"\"\"\n        try:\n            import sys\n            sys.exit(0)\n        except:\n            os._exit(0)\n    \n    def check_database_status(self):\n        \"\"\"Check database status\"\"\"\n        try:\n            if os.path.exists(self.db_path):\n                conn = sqlite3.connect(self.db_path, timeout=2.0)\n                cursor = conn.cursor()\n                cursor.execute(\"SELECT COUNT(*) FROM planetary_positions\")\n                count = cursor.fetchone()[0]\n                conn.close()\n                \n                if count > 0:\n                    self.status_label.config(text=f\"âœ… Database: {count:,} records\", foreground=\"green\")\n                    self.results_text.insert(tk.END, f\"ğŸ“Š Database Status: {count:,} records available\\n\\n\")\n                else:\n                    self.status_label.config(text=\"ğŸ“‚ Database empty\", foreground=\"orange\")\n                    self.results_text.insert(tk.END, \"ğŸ“‚ Database exists but contains no data\\n\\n\")\n            else:\n                self.status_label.config(text=\"âŒ No database\", foreground=\"red\")\n                self.results_text.insert(tk.END, \"âŒ No database found\\n\\n\")\n                self.results_text.insert(tk.END, \"ğŸ’¡ You can still test the calculator without a database\\n\\n\")\n                \n        except Exception as e:\n            self.status_label.config(text=\"âŒ Database error\", foreground=\"red\")\n            self.results_text.insert(tk.END, f\"âŒ Database check failed: {e}\\n\\n\")\n    \n    def safe_query_data(self):\n        \"\"\"Query data with error handling\"\"\"\n        try:\n            self.results_text.delete(1.0, tk.END)\n            self.results_text.insert(tk.END, \"ğŸ” Querying data...\\n\\n\")\n            self.root.update()\n            \n            # Get selected date/time\n            try:\n                if hasattr(self, 'date_entry'):\n                    selected_date = self.date_entry.get_date()\n                else:\n                    date_str = self.date_var.get()\n                    selected_date = datetime.strptime(date_str, \"%Y-%m-%d\").date()\n            except:\n                selected_date = datetime(2024, 1, 1).date()\n            \n            hour = int(self.hour_var.get())\n            minute = int(self.minute_var.get())\n            \n            target_datetime = datetime.combine(selected_date, \n                                             datetime.min.time().replace(hour=hour, minute=minute))\n            \n            self.results_text.insert(tk.END, f\"ğŸ“… Target: {target_datetime}\\n\\n\")\n            \n            # Check database\n            if not os.path.exists(self.db_path):\n                self.results_text.insert(tk.END, \"âŒ No database found\\n\\n\")\n                self.results_text.insert(tk.END, \"ğŸ’¡ Use 'Test Calculator' to see current positions\\n\")\n                return\n            \n            # Query database\n            conn = sqlite3.connect(self.db_path, timeout=5.0)\n            cursor = conn.cursor()\n            \n            cursor.execute(\"\"\"\n            SELECT * FROM planetary_positions \n            WHERE timestamp = ?\n            \"\"\", (target_datetime.isoformat(),))\n            \n            result = cursor.fetchone()\n            \n            if result:\n                self.display_database_result(result)\n            else:\n                # Find nearest\n                cursor.execute(\"\"\"\n                SELECT *, ABS(julianday(timestamp) - julianday(?)) * 24 * 60 as diff_minutes\n                FROM planetary_positions \n                WHERE ABS(julianday(timestamp) - julianday(?)) * 24 * 60 <= 60\n                ORDER BY diff_minutes ASC LIMIT 1\n                \"\"\", (target_datetime.isoformat(), target_datetime.isoformat()))\n                \n                nearest = cursor.fetchone()\n                if nearest:\n                    diff_minutes = nearest[-1]\n                    self.results_text.insert(tk.END, f\"âš ï¸ Exact time not found, showing nearest data ({diff_minutes:.1f} min difference)\\n\\n\")\n                    self.display_database_result(nearest)\n                else:\n                    self.results_text.insert(tk.END, \"âŒ No data found within 1 hour of requested time\\n\\n\")\n            \n            conn.close()\n            \n        except Exception as e:\n            self.results_text.insert(tk.END, f\"âŒ Query error: {e}\\n\\n\")\n            print(f\"Query error: {e}\")\n            traceback.print_exc()\n    \n    def display_database_result(self, data):\n        \"\"\"Display database result\"\"\"\n        try:\n            timestamp = data[1]\n            self.results_text.insert(tk.END, f\"âœ… Data found for: {timestamp}\\n\\n\")\n            \n            # Display planetary positions\n            planets = [\n                ('Sun', 6, 7, 8),       # longitude, sign, degree_in_sign\n                ('Moon', 10, 11, 12),\n                ('Mars', 14, 15, 16),\n                ('Mercury', 18, 19, 20),\n                ('Jupiter', 22, 23, 24),\n                ('Venus', 26, 27, 28),\n                ('Saturn', 30, 31, 32),\n                ('Rahu', 34, 35, 36),\n                ('Ketu', 38, 39, 40)\n            ]\n            \n            self.results_text.insert(tk.END, \"ğŸª Planetary Positions:\\n\")\n            self.results_text.insert(tk.END, \"=\" * 50 + \"\\n\")\n            \n            for planet_name, lon_idx, sign_idx, deg_idx in planets:\n                if lon_idx < len(data):\n                    longitude = data[lon_idx]\n                    sign = data[sign_idx] if sign_idx < len(data) else \"Unknown\"\n                    degree_in_sign = data[deg_idx] if deg_idx < len(data) else 0\n                    \n                    self.results_text.insert(tk.END, \n                        f\"{planet_name.ljust(8)}: {longitude:8.4f}Â° in {sign.ljust(12)} ({degree_in_sign:6.2f}Â°)\\n\")\n            \n            self.results_text.insert(tk.END, \"=\" * 50 + \"\\n\\n\")\n            \n        except Exception as e:\n            self.results_text.insert(tk.END, f\"âŒ Display error: {e}\\n\\n\")\n    \n    def test_calculator(self):\n        \"\"\"Test calculator with current time\"\"\"\n        try:\n            self.results_text.delete(1.0, tk.END)\n            self.results_text.insert(tk.END, \"ğŸ§® Testing Calculator...\\n\\n\")\n            self.root.update()\n            \n            from pyjhora_calculator import ProfessionalAstrologyCalculator\n            \n            calc = ProfessionalAstrologyCalculator()\n            test_time = datetime.now()\n            positions = calc.get_planetary_positions(test_time)\n            \n            self.results_text.insert(tk.END, f\"âœ… Calculator Test Successful\\n\\n\")\n            self.results_text.insert(tk.END, f\"ğŸ“… Test Time: {test_time.strftime('%Y-%m-%d %H:%M:%S')}\\n\\n\")\n            \n            self.results_text.insert(tk.END, \"ğŸª Current Planetary Positions:\\n\")\n            self.results_text.insert(tk.END, \"=\" * 50 + \"\\n\")\n            \n            for planet, data in positions.items():\n                longitude = data['longitude']\n                sign = data['sign']\n                degree_in_sign = data['degree_in_sign']\n                \n                self.results_text.insert(tk.END, \n                    f\"{planet.ljust(8)}: {longitude:8.4f}Â° in {sign.ljust(12)} ({degree_in_sign:6.2f}Â°)\\n\")\n            \n            self.results_text.insert(tk.END, \"=\" * 50 + \"\\n\\n\")\n            self.results_text.insert(tk.END, \"ğŸ’¡ Calculator is working correctly!\\n\")\n            \n        except Exception as e:\n            self.results_text.insert(tk.END, f\"âŒ Calculator test failed: {e}\\n\\n\")\n            print(f\"Calculator test error: {e}\")\n            traceback.print_exc()\n    \n    def run(self):\n        \"\"\"Run the application\"\"\"\n        try:\n            if not self.root:\n                raise Exception(\"GUI not initialized\")\n            self.root.mainloop()\n        except Exception as e:\n            print(f\"Application error: {e}\")\n            traceback.print_exc()\n        finally:\n            self.safe_exit()\n\ndef main():\n    \"\"\"Main function\"\"\"\n    try:\n        print(\"ğŸŒŸ Starting Simple Planetary Data Browser...\")\n        browser = SimplePlanetaryBrowser()\n        browser.run()\n    except Exception as e:\n        print(f\"Failed to start browser: {e}\")\n        traceback.print_exc()\n        try:\n            messagebox.showerror(\"Startup Error\", f\"Failed to start application:\\n{e}\")\n        except:\n            pass\n        import sys\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    main()