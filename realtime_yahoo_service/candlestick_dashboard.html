<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Candlestick Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }
        
        select, button {
            padding: 12px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        select {
            background: white;
            color: #333;
            min-width: 200px;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-banner {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .status-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .stat-value.up {
            color: #059669;
        }
        
        .stat-value.down {
            color: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“ˆ Real-Time Candlestick Chart</h1>
            
            <div class="controls">
                <div class="control-group">
                    <label>Select Symbol</label>
                    <select id="symbolSelect" onchange="changeSymbol()">
                        <option value="">-- Select a symbol --</option>
                        <option value="GC=F">Gold Futures (GC=F)</option>
                        <option value="SI=F">Silver Futures (SI=F)</option>
                        <option value="CL=F">Crude Oil Futures (CL=F)</option>
                        <option value="ES=F">E-mini S&P 500 (ES=F)</option>
                        <option value="NQ=F">Nasdaq 100 Futures (NQ=F)</option>
                        <option value="YM=F">Mini Dow Jones (YM=F)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label>Actions</label>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="connect()" id="connectBtn">Connect</button>
                        <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
                        <button onclick="clearChart()" id="clearBtn">Clear Chart</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-banner">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
                <span id="dataCount" style="margin-left: 20px; color: #6b7280;"></span>
            </div>
            <div style="font-size: 14px; color: #6b7280;">
                Last update: <span id="lastUpdate">Never</span>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Current Price</div>
                <div class="stat-value" id="currentPrice">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Open</div>
                <div class="stat-value" id="openPrice">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">High</div>
                <div class="stat-value" id="highPrice">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Low</div>
                <div class="stat-value" id="lowPrice">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Volume</div>
                <div class="stat-value" id="volume">--</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Change</div>
                <div class="stat-value" id="change">--</div>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-wrapper" id="chartWrapper">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“Š</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                        Select a symbol to view candlestick chart
                    </div>
                    <div>Choose a symbol from the dropdown above and click Connect</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let chart = null;
        let selectedSymbol = '';
        let candleData = {};
        let dataPoints = [];
        
        function connect() {
            if (!selectedSymbol) {
                alert('Please select a symbol first');
                return;
            }
            
            try {
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = () => {
                    document.getElementById('statusDot').classList.remove('offline');
                    document.getElementById('statusText').textContent = 'Connected - Receiving data...';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    
                    initializeChart();
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                ws.onclose = () => {
                    document.getElementById('statusDot').classList.add('offline');
                    document.getElementById('statusText').textContent = 'Disconnected';
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                };
            } catch (e) {
                console.error('Connection failed:', e);
                alert('Failed to connect: ' + e.message);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function changeSymbol() {
            const select = document.getElementById('symbolSelect');
            selectedSymbol = select.value;
            
            if (selectedSymbol) {
                // Clear previous data
                dataPoints = [];
                candleData = {};
                
                // If connected, reinitialize chart
                if (ws && ws.readyState === WebSocket.OPEN) {
                    initializeChart();
                }
            }
        }
        
        function clearChart() {
            dataPoints = [];
            candleData = {};
            if (chart) {
                chart.data.datasets[0].data = [];
                chart.update();
            }
            document.getElementById('dataCount').textContent = '';
            updateStats(null);
        }
        
        function initializeChart() {
            // Remove empty state
            const wrapper = document.getElementById('chartWrapper');
            wrapper.innerHTML = '<canvas id="chart"></canvas>';
            
            // Show stats
            document.getElementById('statsGrid').style.display = 'grid';
            
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: selectedSymbol,
                        data: dataPoints,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        color: {
                            up: '#059669',
                            down: '#dc2626',
                            unchanged: '#6b7280'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `${selectedSymbol} - Real-Time Candlestick Chart`,
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Open: $${point.o.toFixed(2)}`,
                                        `High: $${point.h.toFixed(2)}`,
                                        `Low: $${point.l.toFixed(2)}`,
                                        `Close: $${point.c.toFixed(2)}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: false,
                            grace: '5%',
                            title: {
                                display: true,
                                text: 'Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            afterDataLimits: (scale) => {
                                // Add padding to make the chart more readable
                                const range = scale.max - scale.min;
                                const padding = range * 0.1;
                                scale.min = scale.min - padding;
                                scale.max = scale.max + padding;
                            }
                        }
                    }
                }
            });
        }
        
        function handleMessage(message) {
            const eventType = message.event_type || message.channel || '';
            
            if (eventType.includes('candle') || (message.data && message.data.symbol)) {
                const data = message.data || message;
                
                // Only process data for selected symbol
                if (data.symbol === selectedSymbol) {
                    updateChartData(data);
                }
            }
        }
        
        function updateChartData(data) {
            console.log('Received data for chart:', data);
            
            const timestamp = data.timestamp ? data.timestamp * 1000 : Date.now();
            const open = data.open_price || data.open || 0;
            const high = data.high_price || data.high || 0;
            const low = data.low_price || data.low || 0;
            const close = data.close_price || data.close || 0;
            
            if (open === 0 && high === 0 && low === 0 && close === 0) {
                return; // Skip invalid data
            }
            
            // Create candlestick data point
            const candlePoint = {
                x: timestamp,
                o: open,
                h: high,
                l: low,
                c: close
            };
            
            // Add to data points
            dataPoints.push(candlePoint);
            
            // Keep only last 50 candles
            if (dataPoints.length > 50) {
                dataPoints.shift();
            }
            
            // Update chart
            if (chart) {
                chart.data.datasets[0].data = dataPoints;
                
                // Force recalculate scale limits
                chart.options.scales.y.min = undefined;
                chart.options.scales.y.max = undefined;
                
                chart.update('none'); // Update without animation for smooth real-time
            }
            
            // Update stats
            updateStats(data);
            
            // Update counters
            document.getElementById('dataCount').textContent = `${dataPoints.length} candles`;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function updateStats(data) {
            if (!data) {
                document.getElementById('currentPrice').textContent = '--';
                document.getElementById('openPrice').textContent = '--';
                document.getElementById('highPrice').textContent = '--';
                document.getElementById('lowPrice').textContent = '--';
                document.getElementById('volume').textContent = '--';
                document.getElementById('change').textContent = '--';
                return;
            }
            
            const close = data.close_price || data.close || 0;
            const open = data.open_price || data.open || 0;
            const high = data.high_price || data.high || 0;
            const low = data.low_price || data.low || 0;
            const volume = data.volume || 0;
            const prevClose = data.prev_close || open;
            
            const change = close - prevClose;
            const changePercent = prevClose > 0 ? (change / prevClose * 100) : 0;
            
            document.getElementById('currentPrice').textContent = '$' + close.toFixed(2);
            document.getElementById('currentPrice').className = 'stat-value ' + (change >= 0 ? 'up' : 'down');
            
            document.getElementById('openPrice').textContent = '$' + open.toFixed(2);
            document.getElementById('highPrice').textContent = '$' + high.toFixed(2);
            document.getElementById('lowPrice').textContent = '$' + low.toFixed(2);
            document.getElementById('volume').textContent = formatVolume(volume);
            
            const changeElem = document.getElementById('change');
            changeElem.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + ' (' + changePercent.toFixed(2) + '%)';
            changeElem.className = 'stat-value ' + (change >= 0 ? 'up' : 'down');
        }
        
        function formatVolume(volume) {
            if (volume === 0) return '-';
            if (volume >= 1000000000) return (volume / 1000000000).toFixed(2) + 'B';
            if (volume >= 1000000) return (volume / 1000000).toFixed(2) + 'M';
            if (volume >= 1000) return (volume / 1000).toFixed(2) + 'K';
            return volume.toLocaleString();
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            disconnect();
        });
    </script>
</body>
</html>
